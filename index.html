<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–µ–∫—É–Ω–¥–æ–º–µ—Ä –¥–ª—è –∑–∞–µ–∑–¥–æ–≤</title>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f2f2f2; }
    input, button, select { font-size: 1em; padding: 8px; margin: 5px; }
    .timer { font-size: 2em; margin: 10px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: center; }
    th { background-color: #eee; }
  </style>
</head>
<body>

<h2>–°–µ–∫—É–Ω–¥–æ–º–µ—Ä –¥–ª—è –∑–∞–µ–∑–¥–æ–≤ (—Ç–æ—á–Ω–æ—Å—Ç—å –¥–æ —Ç—ã—Å—è—á–Ω—ã—Ö)</h2>

<label>–ù–æ–º–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞:</label><br/>
<input id="riderId" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 101"><br/>

<button onclick="startRace()">–°–¢–ê–†–¢</button>
<button onclick="finishRace()">–§–ò–ù–ò–®</button>

<div class="timer" id="timer">00:00.000</div>

<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
<table id="results">
  <thead>
    <tr>
      <th>–ù–æ–º–µ—Ä</th>
      <th>–°—Ç–∞—Ä—Ç</th>
      <th>–§–∏–Ω–∏—à</th>
      <th>–í—Ä–µ–º—è</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button onclick="downloadCSV()">üìÑ –°–∫–∞—á–∞—Ç—å CSV</button>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDiIjOc2nbdjqhldebc9FYD1nzgjQm2OaE",
    authDomain: "racetimer-eb717.firebaseapp.com",
    databaseURL: "https://racetimer-eb717-default-rtdb.firebaseio.com",
    projectId: "racetimer-eb717",
    storageBucket: "racetimer-eb717.firebasestorage.app",
    messagingSenderId: "207619945096",
    appId: "1:207619945096:web:c2e6824b97ecd50dc7a53d"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  firebase.auth().signInAnonymously();

  let interval = null;

  function getCurrentTimeMs() {
    return Date.now();
  }

  function formatDuration(ms) {
    const min = String(Math.floor(ms / 60000)).padStart(2, '0');
    const sec = String(Math.floor((ms % 60000) / 1000)).padStart(2, '0');
    const mil = String(ms % 1000).padStart(3, '0');
    return `${min}:${sec}.${mil}`;
  }

  function startRace() {
    const rider = document.getElementById("riderId").value.trim();
    if (!rider) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞");

    const timestamp = getCurrentTimeMs();

    db.ref("races/" + rider).set({ start: timestamp }).then(() => {
      document.getElementById("timer").textContent = "–°–¢–ê–†–¢: " + new Date(timestamp).toLocaleTimeString();
      // –ü–æ–∫–∞–∑–∞—Ç—å –∂–∏–≤–æ–µ –≤—Ä–µ–º—è
      if (interval) clearInterval(interval);
      interval = setInterval(() => {
        const now = Date.now();
        const duration = now - timestamp;
        document.getElementById("timer").textContent = "–í–†–ï–ú–Ø: " + formatDuration(duration);
      }, 50);
    });
  }

  function finishRace() {
    const rider = document.getElementById("riderId").value.trim();
    if (!rider) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞");

    const timestamp = getCurrentTimeMs();

    const raceRef = db.ref("races/" + rider);
    raceRef.once("value").then(snap => {
      const data = snap.val();
      if (!data || !data.start) {
        document.getElementById("timer").textContent = "–û—à–∏–±–∫–∞: —Å—Ç–∞—Ä—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω";
        return;
      }
      if (data.finish) {
        document.getElementById("timer").textContent = "–£—á–∞—Å—Ç–Ω–∏–∫ —É–∂–µ —Ñ–∏–Ω–∏—à–∏—Ä–æ–≤–∞–ª";
        return;
      }
      const duration = timestamp - data.start;
      raceRef.update({
        finish: timestamp,
        duration: duration
      });
      document.getElementById("timer").textContent = "–ò–¢–û–ì–û: " + formatDuration(duration);
      if (interval) clearInterval(interval);
    });
  }

  // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É
  function renderResults(snapshot) {
    const tbody = document.querySelector("#results tbody");
    tbody.innerHTML = "";
    const data = snapshot.val();
    if (!data) return;

    Object.keys(data).forEach(riderId => {
      const item = data[riderId];
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${riderId}</td>
        <td>${item.start ? new Date(item.start).toLocaleTimeString() : ""}</td>
        <td>${item.finish ? new Date(item.finish).toLocaleTimeString() : ""}</td>
        <td>${item.duration ? formatDuration(item.duration) : ""}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  db.ref("races").on("value", renderResults);

  // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
  function downloadCSV() {
    const rows = [["–ù–æ–º–µ—Ä", "–°—Ç–∞—Ä—Ç", "–§–∏–Ω–∏—à", "–í—Ä–µ–º—è"]];
    db.ref("races").once("value").then(snapshot => {
      const data = snapshot.val();
      if (!data) return;
      Object.keys(data).forEach(riderId => {
        const r = data[riderId];
        rows.push([
          riderId,
          r.start ? new Date(r.start).toLocaleTimeString() : "",
          r.finish ? new Date(r.finish).toLocaleTimeString() : "",
          r.duration ? formatDuration(r.duration) : ""
        ]);
      });
      const csvContent = rows.map(e => e.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "results.csv";
      a.click();
    });
  }
</script>

</body>
</html>
