<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–µ–∫—É–Ω–¥–æ–º–µ—Ä –≥–æ–Ω–∫–∏</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .section { margin-bottom: 30px; }
    .participant-list li { margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; }
    .participant-list button { margin-left: 5px; }
    table, th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    input, select { margin-bottom: 10px; display: block; width: 100%; padding: 6px; }
    button.edit, button.delete { margin-left: 5px; }
    #liveTimerDisplay { font-weight: bold; font-size: 1.5em; color: green; margin-top: 10px; }
    .live-controls { margin-top: 10px; }
    @media (max-width: 600px) {
      body { padding: 10px; }
      input, select, button { font-size: 1.2em; }
      table, th, td { font-size: 0.9em; }
    }
  </style>
</head>
<body>
  <h1>–•—Ä–æ–Ω–æ–º–µ—Ç—Ä–∞–∂ –≥–æ–Ω–∫–∏</h1>

  <div class="section">
    <h2>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤—Ä—É—á–Ω—É—é</h2>
    <input type="text" id="manualId" placeholder="–ù–æ–º–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞" />
    <input type="text" id="manualName" placeholder="–§–ò–û —É—á–∞—Å—Ç–Ω–∏–∫–∞" />
    <input type="text" id="manualTeam" placeholder="–ö–æ–º–∞–Ω–¥–∞" />
    <select id="manualCategory">
      <option>–ú–∞—Å—Ç–µ—Ä–∞ –ú—É–∂—á–∏–Ω—ã / Men Master</option>
      <option>–≠–ª–∏—Ç–∞ –ú—É–∂—á–∏–Ω—ã / Man Elite</option>
      <option>–Æ–Ω–∏–æ—Ä—ã / Junior</option>
      <option>–ñ–µ–Ω—â–∏–Ω—ã / Women</option>
      <option>–û—Ç–∫—Ä—ã—Ç–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è / Open</option>
      <option>–ï–ª–µ–∫—Ç—Ä–æ-–º–∞—É–Ω—Ç–∏–Ω–±–∞–π–∫–∏ / E-mtb</option>
    </select>
    <button onclick="addManualParticipant()">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</button>
  </div>

  <div class="section">
    <h2>–ò–º–ø–æ—Ä—Ç –∏–∑ Excel</h2>
    <input type="file" id="excelInput" accept=".xlsx, .xls" />
    <button onclick="importExcel()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
  </div>

  <div class="section">
    <h2>–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h2>
    <ul id="participantList" class="participant-list"></ul>
  </div>

  <div class="section">
    <h2>Live-—Å–µ–∫—É–Ω–¥–æ–º–µ—Ä</h2>
    <div id="liveTimerDisplay">00:00.000</div>
    <div class="live-controls">
      <button onclick="startLiveTimer()">–°—Ç–∞—Ä—Ç</button>
      <button onclick="stopLiveTimer()">–§–∏–Ω–∏—à</button>
      <button onclick="resetLiveTimer()">–°–±—Ä–æ—Å</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDiIjOc2nbdjqhldebc9FYD1nzgjQm2OaE",
      authDomain: "racetimer-eb717.firebaseapp.com",
      databaseURL: "https://racetimer-eb717-default-rtdb.firebaseio.com",
      projectId: "racetimer-eb717",
      storageBucket: "racetimer-eb717.appspot.com",
      messagingSenderId: "207619945096",
      appId: "1:207619945096:web:c2e6824b97ecd50dc7a53d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let participantTimers = {};

    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
      const seconds = (totalSeconds % 60).toString().padStart(2, '0');
      const milliseconds = (ms % 1000).toString().padStart(3, '0');
      return `${minutes}:${seconds}.${milliseconds}`;
    }

    function renderParticipants() {
      const list = document.getElementById("participantList");
      list.innerHTML = "";
      db.ref("participants").orderByKey().once("value", snap => {
        const data = snap.val();
        const sortedIds = Object.keys(data || {}).sort((a, b) => +a - +b);
        for (const id of sortedIds) {
          const p = data[id];
          const li = document.createElement("li");
          if (p.startTime && !p.finishTime) {
            li.style.backgroundColor = "#fff5cc"; // –∞–∫—Ç–∏–≤–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫
          }

          li.innerHTML = `<strong>${id}</strong>: ${p.name}, ${p.team}, ${p.category}`;

          const timerSpan = document.createElement("span");
          timerSpan.id = `timer-${id}`;
          timerSpan.style.marginLeft = "10px";
          timerSpan.style.fontWeight = "bold";
          timerSpan.style.color = "green";

          if (p.startTime && !p.finishTime) {
            const startTimestamp = new Date(p.startTime).getTime();
            participantTimers[id] = setInterval(() => {
              const now = Date.now();
              const elapsed = now - startTimestamp;
              timerSpan.textContent = `‚è± ${formatTime(elapsed)}`;
            }, 100);
          } else if (p.result) {
            timerSpan.textContent = `‚è± ${p.result}`;
          }

          li.appendChild(timerSpan);

          const startBtn = document.createElement("button");
          startBtn.textContent = "–°—Ç–∞—Ä—Ç";
          startBtn.disabled = !!p.startTime;
          startBtn.onclick = () => {
            const time = new Date().toISOString();
            db.ref("participants/" + id).update({ startTime: time });
            renderParticipants();
          };

          const finishBtn = document.createElement("button");
          finishBtn.textContent = "–§–∏–Ω–∏—à";
          finishBtn.disabled = !p.startTime || !!p.finishTime;
          finishBtn.onclick = () => {
            const time = new Date().toISOString();
            db.ref("participants/" + id).once("value", snap => {
              const p = snap.val();
              const start = new Date(p.startTime).getTime();
              const finish = new Date(time).getTime();
              const diff = finish - start;
              const result = formatTime(diff);
              db.ref("participants/" + id).update({ finishTime: time, result });
              clearInterval(participantTimers[id]);
              renderParticipants();
            });
          };

          const editBtn = document.createElement("button");
          editBtn.textContent = "‚úèÔ∏è";
          editBtn.className = "edit";
          editBtn.onclick = () => editParticipant(id);

          const delBtn = document.createElement("button");
          delBtn.textContent = "üóëÔ∏è";
          delBtn.className = "delete";
          delBtn.onclick = () => deleteParticipant(id);

          li.appendChild(startBtn);
          li.appendChild(finishBtn);
          li.appendChild(editBtn);
          li.appendChild(delBtn);
          list.appendChild(li);
        }
      });
    }

    function addManualParticipant() {
      const id = document.getElementById("manualId").value.trim();
      const name = document.getElementById("manualName").value.trim();
      const team = document.getElementById("manualTeam").value.trim();
      const category = document.getElementById("manualCategory").value;
      if (!id || !name) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∏ –∏–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞");

      db.ref("participants/" + id).once("value", snap => {
        if (snap.exists()) {
          return alert("–£—á–∞—Å—Ç–Ω–∏–∫ —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
        }
        db.ref("participants/" + id).set({ name, team, category });
        alert("–£—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω!");
        document.getElementById("manualId").value = "";
        document.getElementById("manualName").value = "";
        document.getElementById("manualTeam").value = "";
        renderParticipants();
      });
    }

    function importExcel() {
      const input = document.getElementById("excelInput");
      const reader = new FileReader();
      reader.onload = e => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);
        rows.forEach(row => {
          const id = String(row["–ù–æ–º–µ—Ä"] || row["ID"] || row["Id"] || row["id"]);
          const name = row["–§–ò–û"] || row["–ò–º—è"] || row["Name"] || row["name"];
          const team = row["–ö–æ–º–∞–Ω–¥–∞"] || row["Team"] || "";
          const category = row["–ö–∞—Ç–µ–≥–æ—Ä–∏—è"] || row["Category"] || "–û—Ç–∫—Ä—ã—Ç–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è / Open";
          if (id && name) {
            db.ref("participants/" + id).once("value", snap => {
              if (!snap.exists()) {
                db.ref("participants/" + id).set({ name, team, category });
              }
            });
          }
        });
        alert("–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω");
        renderParticipants();
      };
      if (input.files.length) {
        reader.readAsArrayBuffer(input.files[0]);
      } else {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª Excel");
      }
    }

    function editParticipant(id) {
      const name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:");
      const team = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É:");
      const category = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é:");
      if (name && category) {
        db.ref("participants/" + id).update({ name, team, category });
        renderParticipants();
      }
    }

    function deleteParticipant(id) {
      if (confirm("–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞?")) {
        db.ref("participants/" + id).remove();
        clearInterval(participantTimers[id]);
        renderParticipants();
      }
    }

    renderParticipants();

    let startTime, timerInterval;
    const display = document.getElementById("liveTimerDisplay");

    function startLiveTimer() {
      startTime = Date.now();
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        display.textContent = formatTime(elapsed);
      }, 10);
    }

    function stopLiveTimer() {
      clearInterval(timerInterval);
    }

    function resetLiveTimer() {
      clearInterval(timerInterval);
      display.textContent = "00:00.000";
    }
  </script>
</body>
</html>
