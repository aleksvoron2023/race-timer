<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Секундомер гонки - синхронизация</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    button { margin: 0 4px; }
    #liveTimerDisplay { font-weight: bold; font-size: 1.5em; color: green; margin-top: 10px; }
    @media (max-width: 600px) {
      body { padding: 10px; }
      table, th, td, button { font-size: 0.9em; }
    }
  </style>
</head>
<body>
  <h1>Секундомер гонки с синхронизацией</h1>
  <table id="participantsTable">
    <thead>
      <tr>
        <th>Номер</th>
        <th>ФИО</th>
        <th>Команда</th>
        <th>Категория</th>
        <th>Старт</th>
        <th>Финиш</th>
        <th>Результат</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="liveTimerDisplay">00:00.000</div>

  <script>
    // Вставь сюда свои настройки Firebase:
    const firebaseConfig = {
      apiKey: "AIzaSyDiIjOc2nbdjqhldebc9FYD1nzgjQm2OaE",
      authDomain: "racetimer-eb717.firebaseapp.com",
      databaseURL: "https://racetimer-eb717-default-rtdb.firebaseio.com",
      projectId: "racetimer-eb717",
      storageBucket: "racetimer-eb717.firebasestorage.app",
      messagingSenderId: "207619945096",
      appId: "1:207619945096:web:c2e6824b97ecd50dc7a53d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Переменные для секундомера
    let timerInterval = null;
    let startTimestamp = null; // время старта в ms
    let elapsedBeforePause = 0;
    let isRunning = false;

    const liveTimerDisplay = document.getElementById('liveTimerDisplay');
    const tbody = document.querySelector('#participantsTable tbody');

    // Форматирование времени в mm:ss.mmm
    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
      const seconds = (totalSeconds % 60).toString().padStart(2, '0');
      const milliseconds = (ms % 1000).toString().padStart(3, '0');
      return `${minutes}:${seconds}.${milliseconds}`;
    }

    // Обновление дисплея с учётом текущего времени
    function updateDisplay() {
      if (!startTimestamp) {
        liveTimerDisplay.textContent = formatTime(elapsedBeforePause);
        return;
      }
      const now = Date.now();
      const elapsed = elapsedBeforePause + (isRunning ? (now - startTimestamp) : 0);
      liveTimerDisplay.textContent = formatTime(elapsed);
    }

    // Запуск локального интервала обновления
    function startInterval() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateDisplay, 10);
    }

    // Остановка локального интервала
    function stopInterval() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    // Загрузка участников из Firebase и отображение
    function loadParticipants() {
      db.ref('participants').once('value', snap => {
        const data = snap.val() || {};
        // Сортируем по номеру участника
        const sortedIds = Object.keys(data).sort((a,b) => +a - +b);
        tbody.innerHTML = '';
        for (const id of sortedIds) {
          const p = data[id];
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${id}</td>
            <td>${p.name || ''}</td>
            <td>${p.team || ''}</td>
            <td>${p.category || ''}</td>
            <td>${p.startTime ? new Date(p.startTime).toLocaleTimeString('ru-RU', {hour12:false}) : ''}</td>
            <td>${p.finishTime ? new Date(p.finishTime).toLocaleTimeString('ru-RU', {hour12:false}) : ''}</td>
            <td>${p.result || ''}</td>
            <td>
              <button class="start-btn">Старт</button>
              <button class="finish-btn">Финиш</button>
            </td>
          `;
          tbody.appendChild(tr);

          // Кнопка Старт
          tr.querySelector('.start-btn').onclick = () => {
            // Запишем старт участника
            const nowISO = new Date().toISOString();
            db.ref(`participants/${id}`).update({ startTime: nowISO, finishTime: null, result: null });

            // Запишем в общий liveTimer
            const nowMs = Date.now();
            db.ref('liveTimer').set({
              isRunning: true,
              startTimestamp: nowMs,
              elapsedBeforePause: 0,
              activeParticipant: id
            });
          };

          // Кнопка Финиш
          tr.querySelector('.finish-btn').onclick = () => {
            db.ref(`participants/${id}`).once('value', snap => {
              const p = snap.val();
              if (!p.startTime) {
                alert('Сначала нажмите старт у этого участника!');
                return;
              }
              const finishISO = new Date().toISOString();
              const startMs = new Date(p.startTime).getTime();
              const finishMs = Date.now();
              const diffMs = finishMs - startMs;
              const resultStr = formatTime(diffMs);

              // Обновляем участника
              db.ref(`participants/${id}`).update({
                finishTime: finishISO,
                result: resultStr
              });

              // Обновляем liveTimer - останавливаем
              db.ref('liveTimer').set({
                isRunning: false,
                startTimestamp: null,
                elapsedBeforePause: diffMs,
                activeParticipant: null
              });
            });
          };
        }
      });
    }

    // Следим за состоянием liveTimer из Firebase и обновляем локально
    db.ref('liveTimer').on('value', snap => {
      const data = snap.val();
      if (!data) {
        // Если данных нет, сбрасываем таймер
        isRunning = false;
        startTimestamp = null;
        elapsedBeforePause = 0;
        stopInterval();
        liveTimerDisplay.textContent = '00:00.000';
        return;
      }
      isRunning = data.isRunning || false;
      startTimestamp = data.startTimestamp || null;
      elapsedBeforePause = data.elapsedBeforePause || 0;
      updateDisplay();

      if (isRunning) {
        startInterval();
      } else {
        stopInterval();
      }
    });

    // Загружаем участников при старте
    loadParticipants();

  </script>
</body>
</html>
